---
params: 
  sub_title:
    input: text
    label: Sub Title
    value: 'my_Sub_Title_and_File_Name'
title: 'Sierra Leone - Exploratory Data Analysis'
output: word_document
always_allow_html: true
data: 05/19/2022
knit: (
  function(inputFile, encoding) { 
  
    pSubTitle <- 'Sierra Leone health facility EDA'
  
    rmarkdown::render( 
      input       = inputFile, 
      encoding    = encoding, 
      params      = list(sub_title = pSubTitle),      
      output_file = pSubTitle) })
---


``` {r echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
rm(list=ls())

#import libraries
library(tidyverse)
library(ggpubr)
library(readxl)
library(scales)
library(forcats)
library(scales)
library(forcats)
library(knitr)
library (sf)
library(DBI)
library(kableExtra)
library(tmap)
library(leaflet)
library(tools)
sf_use_s2(FALSE)
theme<-theme(plot.title=element_text(face="bold", size=13,hjust = 0.5),
             plot.subtitle  = element_text(color="black",face="bold"),
             axis.text =element_text(color="grey7",face="bold",size=11),
             axis.title =element_text(color="grey7",face="bold",size=11),
             panel.border = element_rect(colour = "black", fill=NA, size=0.5),
             plot.caption=element_text(hjust = -0.01, face="italic", size=16),
             legend.key.height  = unit(0.2,"cm"),
             legend.key.width  = unit(0.4,"cm"),
             legend.spacing.x = unit(0.7, 'cm'),
             legend.position="bottom",
             #legend.justification = c("right", "bottom"),
             #legend.box.just = "",
             legend.margin = margin(15, 15, 15, 15),
             legend.text=element_text(size=11, face="bold"),
             legend.title = element_text( size=14, face='bold'),
             strip.text = element_text(size = 11, face='bold'))


###===INPUTS===###
country_name="Sierra Leone"
input_table<-"D:/grid3/SLE/processing/EDA/GRID3_National_MFL_20221214_preprocessing2.xlsx"
admin1<-"district"
admin2<-"chiefdom"
poi_var_name<-"facility"
poi_var_type<-"facility_type"
poi_var_id<-"facility_id"
poi_var_date<-"date"
lat_var<-"lat"
long_var<-"long"

admin1_layer<-"D:/grid3/data/SLE/boundaries/Sierra_Leone_New_District_Shapefiles.shp"
admin2_layer<-"D:/grid3/data/SLE/boundaries/Sierra_Leone_New_Chiefdom_Shapefiles.shp"
admin1_var<-"FIRST_New1"
admin2_var<-"New_Chief"

if (is.na(admin1) ){admin1<-"it does not exist in the dataset"}
if (is.na(admin2) ){admin2<-"it does not exist in the dataset"}
if (is.na(poi_var_type) ){poi_var_type<-"it does not exist in the dataset"}


### PROCESS >> Do not edit below ###

# read data
input_table_type<-tools::file_ext(input_table)
if ( input_table_type=="xlsx"){
input_data<-read_excel(input_table) %>% mutate(lat=ifelse(!!rlang::sym(lat_var) == 0 , NA, !!rlang::sym(lat_var)),
                                               long=ifelse(!!rlang::sym(long_var) == 0 , NA, !!rlang::sym(long_var)))}
                                       
if ( input_table_type=="csv"){
input_data<-read_csv(input_table) %>% mutate(lat=ifelse(!!rlang::sym(lat_var) == 0 , NA, !!rlang::sym(lat_var)),
                                               long=ifelse(!!rlang::sym(long_var) == 0 , NA, !!rlang::sym(long_var)))}

# create admin1 and admin2 variabels if they are not exists in datasets as NA
if (!admin1 %in% names(input_data)){input_data<-input_data %>% mutate(admin1=NA)}
if (!admin2 %in% names(input_data)){input_data<-input_data %>% mutate(admin2=NA)}

# get only PoI  with lat/long
get_spatial<-input_data %>% filter(!is.na(lat)& !is.na(long) ) %>% 
  st_as_sf(coords = c("long", "lat"),crs = "+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0")

projection_name<-st_crs(get_spatial)$proj4string

# get input file names
input_table_name<-basename(input_table)
if (!is.na(admin1)){
  # get layer name
  admin1_layer_name<-basename(admin1_layer)
  # read admin1 layer
  admin1_bdry<-st_read(admin1_layer,quiet = TRUE)
  # admin1_bdry<- sf::st_zm(sf::st_read( "D:/Grid3/GHFD/RWA/RWA_GHFD_06302022.gdb",
  #              layer="District_Boundary", type=7), drop=TRUE, what="ZM")
  # sf::st_geometry(admin1_bdry) <- "geometry"
  # count hf points in admin 1 boundary
  admin1_hf_count<-st_join(admin1_bdry, get_spatial) %>% st_drop_geometry()%>% group_by(!!rlang::sym(admin1_var)) %>% summarize(p_count=n())
}else{admin1_layer_name<-"Admin1 attribute do not exist in the PoI table"}

count_outof_country<-(get_spatial %>% nrow())-(admin1_hf_count %>% pull(p_count) %>% sum())

if (!is.na(admin2)){
  # get layer name
  admin2_layer_name<-basename(admin2_layer)
  # read admin1 layer
  admin2_bdry<-st_read(admin2_layer,quiet = TRUE)
  # admin2_bdry<- sf::st_zm(sf::st_read( "D:/Grid3/GHFD/RWA/RWA_GHFD_06302022.gdb",
  #              layer="Sector_Boundary", type=7), drop=TRUE, what="ZM")
  # sf::st_geometry( admin2_bdry) <- "geometry"
  
  # count hf points in admin 1 boundary
  admin2_hf_count<-st_join(admin2_bdry, get_spatial) %>% st_drop_geometry()%>% group_by(!!rlang::sym(admin2_var)) %>% summarize(p_count=n())
}else{admin2_layer_name<-"Admin2 attribute do not exist in the PoI  table"}




```



# Objective
+ This document provides an overview of an exploratory data analysis conducted for **`r country_name`**. 
  The following data file is considered for this analysis:
  **`r input_table_name`**


***

# Data inputs
+ Input table : **`r input_table_name`** 
+ Admin 1 boundary: **`r admin1_layer_name`** 
+ Admin 2 boundary: **`r admin2_layer_name`** 
+ Admin 1 field in input table : **`r admin1`** 
+ Admin 2 field in input table : **`r admin2`** 
+ Health facility name field in input table : **`r poi_var_name`** 
+ Health facility type field in input table : **`r poi_var_type`**

***


``` {r echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE}
#get count of na rows in admin columns and facility name column
admin1_na<-input_data %>% filter(is.na(!!rlang::sym(admin1)))%>% nrow()

if (!is.na(admin2)){admin2_na<-input_data %>% filter(is.na(!!rlang::sym(admin2))) %>% nrow()
 admin2_na<-paste0("There are " ,admin2_na," health facilities with missing " , admin2," values.")}else{
   admin2_na<-"There is no admin 2 attribute in the dataset"}

fname_na<-input_data %>% filter(is.na(!!rlang::sym(poi_var_name))) %>% nrow()

if (!is.na(poi_var_type)){
 type_count<-length(input_data %>% pull(!!rlang::sym(poi_var_type)) %>% unique())
 type_count<-paste0("There are " ,type_count," facility types in total in the input dataset.")}else{
   type_count<-"There is no facility type attribute in the dataset"}

if (!is.na(poi_var_date) ){poi_var_date<-paste0("Date column exists in the input dataset with name of ",poi_var_date,".")}else{
  poi_var_date<-"Date attribute does not exist in the input datset."}
  
if (!is.na(poi_var_id) ){poi_var_id<-paste0("Health facility unique identifier attribute exists in the input dataset with name of ",poi_var_id,".")}else{
  poi_var_id<-"Health facility unique identifier does not exist in the input dataset."
}

```

## The input dataset summary

+ The input dataset has  `r ncol(input_data)-23` columns and `r nrow(input_data)` records.
+ There are  `r admin1_na` health facilities with missing `r admin1` values. 
+ `r admin2_na`
+ There are  `r fname_na` health facilities with missing names. 
+ `r type_count`
+ `r poi_var_date`
+ `r poi_var_id`
+ The input dataset projection is WGS84.
+ There are  `r count_outof_country` health facilities that fall outside of the country boundary. 

<br>

***

\newpage

### Health facility locations:
+ The map below shows PoI points that have lat/long. PoI are color coded based on facility type (`r poi_var_type`)

<br>

``` {r echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE,fig.height=10 ,fig.width=10}
library(tmaptools)
osm_NLD <- read_osm(admin1_bdry, ext=1.5)
tmap_mode('plot') 
tmap::tm_shape(osm_NLD) + tm_rgb()+
  tm_shape(admin1_bdry) +
  tm_borders("black", lwd = 1.3) +
  tm_shape(get_spatial) +
tm_dots(col=poi_var_type,palette="magma",id="something", size=0.05,border.col = "black", title="facility types",border.lwd = 2)+
tm_layout(legend.bg.color = "grey",frame.double.line=TRUE)
 
```

\newpage
### Descriptive statistics


``` {r echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE,fig.height=4.5, fig.width=12}

  summary_by_lat_long<-input_data %>%  
    mutate(has_latlong=case_when(!is.na(lat)~ "With geospatial",TRUE ~ as.character("Non-geospatial"))) %>% 
  group_by(has_latlong) %>% summarise(Count=n()) %>%
  mutate(percent = prop.table(Count),  prc=paste0( "%",round(percent*100, 1)," (", comma(Count),")"))  
  ymax<-summary_by_lat_long %>% pull(Count) %>% max()
p1<-summary_by_lat_long %>% 
  ggplot( aes(x="",y=Count, fill=has_latlong))+
   geom_bar(stat="identity")+
  geom_text(aes(label = prc),size=5,
    position=position_stack(0.5))+
    scale_fill_manual(values = c( "red2","forestgreen"))+
    labs(x="",y=" ", fill="", title = "Percentage of data points with geographic coordinates",
         caption=" \n ")+coord_polar("y")+theme_void()

  
summary_by_duplicates<-input_data %>%group_by(poi_uuid_isUnique) %>% 
  summarise(Count=n()) %>% 
  mutate(theme="health facility",value=case_when(poi_uuid_isUnique==1~"Duplicated",
                                                 poi_uuid_isUnique==0~"Unique")) %>% 
   mutate(percent = prop.table(Count),  prc=paste0( "%",round(percent*100, 1)," (", comma(Count),")")) 

  ymax<-summary_by_duplicates%>% pull(Count) %>% max()
p2<-summary_by_duplicates %>% 
  ggplot( aes(x="",y=Count, fill=value))+
   geom_bar(stat="identity")+
  geom_text(aes(label = prc),size=5,
    position = position_stack(0.5))+
    scale_fill_manual(values = c( "red2","forestgreen"))+
    labs(x="",y=" ", fill="",title = "Percentage of data points with unique data values",
        caption="Uniqueness based on a combination of admin 1, admin 2 and\n name of the facility")+coord_polar("y")+theme_void()+
theme(plot.caption=element_text(hjust = -0.01, face="italic", size=12))

  plots<-ggarrange(p1, p2,ncol = 2, nrow = 1, common.legend = FALSE, legend ="right")
plots
```  

***

+ The analysis below considers health facilities with geographic coordinates which are then compared against the spatial boundary dataset, and excludes data points with no available geographic information.


``` {r echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE,fig.height=3, fig.width=7}

admin1_without_hf<-admin1_hf_count %>% mutate(admin1=as.factor(!!rlang::sym(admin1_var))) %>% 
  filter(p_count==0) %>% pull(admin1) %>% unique()
if (length(admin1_without_hf)>0){
  admin1_without_hf_<-paste0(length(admin1_without_hf)," of ", admin1," units without a geospatial health facility point.",
                             "These are ",paste(admin1_without_hf, collapse = ","))
}else {admin1_without_hf_<-paste0("All ", admin1 ," contain at least one geospatial health facility point")}


admin2_without_hf<-admin2_hf_count %>% mutate(admin2=as.factor(!!rlang::sym(admin2_var))) %>% 
  filter(p_count==0) %>% pull(admin2) %>% unique()
if (length(admin2_without_hf)>0){
  admin2_without_hf_<-paste0(length(admin2_without_hf)," of ", admin2," units without a geospatial health facility point.",
                             "These are ",paste(admin2_without_hf, collapse = ","))
}else {admin2_without_hf_<-paste0("All ", admin2 ," contain at least one geospatial health facility point")}


```

 + `r admin1_without_hf_`
 + `r admin2_without_hf_`
 
\newpage

+ The table below summarizes facility types based on the type column.

``` {r echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE,fig.height=4, fig.width=7}

summary_by_type<-input_data %>% mutate(type=!!rlang::sym(poi_var_type)) %>% select(type) %>% 
mutate(type= replace_na(type, "Type missing"))%>% 
group_by(type) %>% summarise(Count=n()) %>%
  mutate(percent = prop.table(Count)*100,  prc=paste0( "%",round(percent, 1),"(", comma(Count),")")) 
ymax<-summary_by_type %>% pull(Count) %>% max()+(summary_by_type %>% pull(Count) %>% max()/100)*15

p1<-summary_by_type %>%   ggplot( aes(x=reorder(type, Count),y=Count, fill=type))+
   geom_bar(stat="identity", width = 0.5)+
  geom_text(aes(label = prc),
    position =position_dodge(0.5),size=3, hjust=0)+guides(fill=FALSE)+
  ylim(0,ymax )+
     labs(x="",y="", fill="", title="Health facility summary by facility types")+coord_flip()+
    theme+
  theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),
        axis.text.y=element_text(size=10),axis.ticks.y=element_blank(),
        panel.background = element_blank(),panel.border = element_blank())
  
p1
```

***
 

\newpage

+ The figure below summarizes the facility by settlement extent type in which the health facilities are located. Settlement extents are classified based on building count. Built-up areas have over 1500 buildings and correspond to cities and towns. Small settlement areas have building counts between 50-1500 and correspond to small towns and villages. Hamlets have less than 50 buildings and correspond to small villages and hamlets. Out of a settlement indicates the health facilities do not fall in a settlement. Only health facilities with geospatial locations are included in the figure.

           
``` {r echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE,fig.height=2.5, fig.width=8}
sett_type<-input_data %>% mutate(settlement_type=case_when(settlement_type=="bua" ~"Built-up\n area",
                                                           settlement_type=="Built-Up Area" ~"Built-up\n area",
                                                           settlement_type=="Built-up Area" ~"Built-up\n area",
                                                            settlement_type=="ssa" ~ "Small\n settlement area",
                                                           settlement_type=="Small Settlement Area" ~ "Small\n settlement area",
                                                           settlement_type=="hamlet" ~ "Hamlet",
                                                            dist_to_settlement_type >0~"Out of a\n settlement",
                                                            TRUE ~ as.character(settlement_type))) %>% select(settlement_type,dist_to_settlement_type )

summary_by_settlement_extent<-sett_type %>% filter(dist_to_settlement_type!=-1) %>% 
  group_by( settlement_type) %>% summarise(Count=n()) %>%
  mutate(percent = prop.table(Count), prc=paste0( "%",round(percent*100, 1),"\n (", comma(Count),")"))  
ymax<-summary_by_settlement_extent %>% pull(Count) %>% max()+(summary_by_settlement_extent %>% pull(Count) %>% max()/10)

summary_by_settlement_extent_p<- summary_by_settlement_extent %>% 
    ggplot( aes(x=factor(settlement_type,
      levels=c("Out of a\n settlement","Hamlet","Small\n settlement area","Built-up\n area")),y=Count,
      fill=factor(settlement_type,levels=c("Out of a\n settlement","Hamlet","Small\n settlement area","Built-up\n area"))))+
   geom_bar(stat="identity", width = 0.8)+
  geom_text(aes(label = prc),
    position = position_dodge(0.5),size=3, hjust=0)+
  guides(fill=FALSE)+labs(x="",y="", 
                          title="Health facility summary based on settlement extents they located")+
  scale_fill_manual(values=c("grey","forestgreen", "orange","red2"))+ylim(0,ymax)+
  coord_flip()+
  theme+
  theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),
        axis.text.y=element_text(size=10),axis.ticks.y=element_blank(),
        panel.background = element_blank(),panel.border = element_blank())
 summary_by_settlement_extent_p
 
``` 
 
 ***
   
+ Figure below summarizes the distance to the nearest settlement for the health facilities that fall outside of a settlement extent. Only facilities with geospatial locations are included in the figure.
 
``` {r echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE,fig.height=3, fig.width=8}

distance_to_sett_extent<-input_data %>%filter(dist_to_settlement_type>0) %>% mutate(dist_to_settlement2 =cut(dist_to_settlement_type , breaks=c(-Inf,100,250,500, 1000, 2500, 5000, Inf), labels=c("<100m","100m-250m","250m-500m","500m-1000m","1000m-2500m","2500m-5000m","5000m >"))) %>% 
  select(dist_to_settlement2) %>% 
  group_by( dist_to_settlement2) %>% summarise(Count=n()) %>%
  mutate(percent = prop.table(Count), prc=paste0( "%",round(percent*100, 1),"\n (",comma(Count),")")) 
ymax<-distance_to_sett_extent %>% pull(Count) %>% max()+(distance_to_sett_extent %>% pull(Count) %>% max()/10)
sett_by_distance_p<- distance_to_sett_extent %>% 
    ggplot( aes(x=factor(dist_to_settlement2,
      levels=c("<100m","100m-250m","250m-500m","500m-1000m","1000m-2500m","2500m-5000m","5000m >")),y=Count,
      fill=factor(dist_to_settlement2,levels=c("<100m","100m-250m","250m-500m","500m-1000m","1000m-2500m","2500m-5000m","5000m >"))))+
   geom_bar(stat="identity", width = 0.8)+
  geom_text(aes(label = prc),
    position = position_dodge(0.5),size=3, hjust=0)+
  guides(fill=FALSE)+labs(x="",y="", title="Distance summary for the health facilities that do not fall into a settlement extent")+
  ylim(0, ymax)+
  coord_flip()+
  theme+
  theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),
        axis.text.y=element_text(size=10),axis.ticks.y=element_blank(),
        panel.background = element_blank(),panel.border = element_blank())
sett_by_distance_p


```
 
***
\newpage


+ The figure below summarizes health facilities that are spatially duplicated. These facilities have identical geospatial locations. 

``` {r echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE,fig.height=2, fig.width=7}

  summary_by_overlapes<-input_data %>%  filter(!is.na(lat)) %>% select(is_overlap) %>% 
    mutate(is_overlap2=case_when(is_overlap=="YES" ~ "Spatial\n duplicate",is_overlap=="NO" ~  "Non-spatial\n duplicate")) %>% 
  group_by( is_overlap2) %>% summarise(Count=n()) %>%
  mutate(percent = prop.table(Count),  prc=paste0( "%",round(percent*100, 1),"\n (", comma(Count),")"))  
ymax<-summary_by_overlapes %>% pull(Count) %>% max()+(summary_by_overlapes %>% pull(Count) %>% max()/10)
summary_by_overlapes_p<-summary_by_overlapes %>% 
  ggplot( aes(x=fct_reorder(is_overlap2,  Count, .desc = FALSE),y=Count, fill=is_overlap2))+
   geom_bar(stat="identity", width = 0.5)+
  geom_text(aes(label = prc),
    position = position_dodge(0.5),size=3, hjust=0)+
  guides(fill=FALSE)+labs(x="",y="", title="Health facilities based on geo-spatial duplication")+
  ylim(0,ymax)+
  coord_flip()+
  theme+
  theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),
        axis.text.y=element_text(size=8),axis.ticks.y=element_blank(),
        panel.background = element_blank(),panel.border = element_blank())
summary_by_overlapes_p

```      

***

+ The figure below summarizes the comparison of admin names in the health facility dataset to the admin names in the admin boundaries. A Fuzzy match method is used to match admin names. Fuzzy match quantifies string similarity between two words (in this case admin names). Admin names from facility and boundary datasets are pulled and matched against each other. Admin names are matched in hierarchical steps meaning that first admin1 then admin2 names are matched.

``` {r echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE,fig.height=4, fig.width=12}

facet_title <- c(`admin1_names_match`=paste0(admin1," names match result"),`admin2_names_match`=paste0(admin2," names match result"))
  
  
summary_by_admin1_match<-input_data %>%   select(admin1_names_match=admin1_clean_match_result,admin2_names_match=admin2_clean_match_result) %>% 
  group_by( admin1_names_match,admin2_names_match) %>% summarise(Count=n()) %>%gather(key, value, -Count) %>% 
    group_by(key, value) %>% summarise(Count=sum(Count)) %>% 
  mutate(percent = prop.table(Count),  prc=paste0( "%",round(percent*100, 1)," (", comma(Count),")"),
        value=case_when(value=="YES"~ "Matched",value=="NO"~ "Not matched") )

summary_by_admin1_match_p<-summary_by_admin1_match %>% 
  ggplot( aes(x="",y=Count, fill=value))+
   geom_bar(stat="identity")+
  geom_text(aes(label = prc),size=5,
   position = position_stack(0.5))+
  scale_fill_manual(values = c( "forestgreen","red2"))+
    labs(x="",y=" ", fill="")+
  coord_polar("y")+
  facet_grid(.~key,labeller = as_labeller(facet_title))+
  theme_void()+theme(strip.text.x = element_text(size = 15, face="bold"),
                     legend.text=element_text(size=13, face="bold"))
summary_by_admin1_match_p

``` 
    
*** 


The figure below summarizes whether facility points fall into  their respective admin boundaries.The admin names from the health facility dataset are compared to the admin names from which the points fall in. The comparison utilizes the fuzzy match method. Only health facilities that have geospatial locations and admin name attributes are included in the figure. 

``` {r echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE,fig.height=4, fig.width=12}
facet_title <- c(`admin1_bdry_names_match`=paste0(admin1," names match result"),`admin2_bdry_names_match`=paste0(admin2," names match result"))

summary_by_admin1_bdry_match<-input_data %>% filter(!is.na(lat)) %>% 
select(admin1_bdry_names_match=admin1_bryMatch,admin2_bdry_names_match=admin2_bryMatch) %>% 
group_by( admin1_bdry_names_match,admin2_bdry_names_match) %>% summarise(Count=n()) %>%gather(key, value, -Count) %>% 
    group_by(key, value) %>% summarise(Count=sum(Count)) %>% 
  mutate(percent = prop.table(Count),  prc=paste0( "%",round(percent*100, 1),"\n(",comma(Count),")"),
         value=case_when(value=="YES"~ "Matched",value=="NO"~ "Not matched") )
 summary_by_admin1_bdry_match_p<- summary_by_admin1_bdry_match %>% 
  ggplot( aes(x="",y=Count, fill=value))+
   geom_bar(stat="identity")+
  geom_text(aes(label = prc),size=5,
   position = position_stack(0.5))+
  scale_fill_manual(values = c( "forestgreen","red2"))+
    labs(x="",y=" ", fill="")+
  coord_polar("y")+
  facet_grid(.~key,labeller = as_labeller(facet_title))+
  theme_void()+theme(strip.text.x = element_text(size = 15, face="bold"),
                     legend.text=element_text(size=13, face="bold"))
 summary_by_admin1_bdry_match_p
``` 
    

*** 


The figure below summarizes the distance between health facilities that do not fall into the correct admin boundary and the edge of their respective admin units.

``` {r echo=FALSE, message=FALSE, warning=FALSE, eval=TRUE,fig.height=4, fig.width=12}

  summary_by_dist_admin1_bdry_match<-input_data %>% filter(!is.na(lat)) %>%
  filter(admin1_bryMatch=="NO" ) %>% 
  select(dist_to_admin1_bry_border_km ) %>% 
  mutate(distance=cut(dist_to_admin1_bry_border_km, breaks=c(-Inf, 1, 2,5,10,25, Inf), 
                      labels=c("<=1km","1-2km","2-5km","5-10km","10-25km", "25km >"))) %>% 
  group_by( distance) %>% summarise(Count=n()) %>%
  mutate(percent = prop.table(Count),  prc=paste0( "%",round(percent*100, 1),"\n (", comma( Count),")"))
 ymax<-summary_by_dist_admin1_bdry_match %>% pull(Count) %>% max()+(summary_by_dist_admin1_bdry_match %>% pull(Count) %>% max()/10)
 
 p1<- summary_by_dist_admin1_bdry_match %>% 
  ggplot( aes(x=distance,y=Count, fill=distance))+
   geom_bar(stat="identity", width = 0.5)+
  geom_text(aes(label = prc),
    position = position_dodge(0.5), hjust=-0.5)+
  guides(fill=FALSE)+labs(x="",y=" ", title=paste0("Distance to " , admin1," boundary"))+
   ylim(0, ymax)+
  coord_flip()+
  theme+
  theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),
        axis.text.y=element_text(size=12),axis.ticks.y=element_blank(),
        panel.background = element_blank(),panel.border = element_blank())


  summary_by_dist_admin2_bdry_match<-input_data %>% filter(!is.na(lat)) %>%
  filter(admin2_bryMatch=="NO" ) %>% 
  select(dist_to_admin2_bry_border_km ) %>% 
  mutate(distance=cut(dist_to_admin2_bry_border_km, breaks=c(-Inf, 1, 2,5,10,25, Inf), 
                      labels=c("<=1km","1-2km","2-5km","5-10km","10-25km", "25km >"))) %>% 
  group_by( distance) %>% summarise(Count=n()) %>%
  mutate(percent = prop.table(Count),  prc=paste0( "%",round(percent*100, 1),"\n (",comma( Count),")")) %>% 
    filter(!is.na(distance))
 ymax<-summary_by_dist_admin2_bdry_match %>% pull(Count) %>% max()+(summary_by_dist_admin2_bdry_match %>% pull(Count) %>% max()/10)
 p2<- summary_by_dist_admin2_bdry_match %>% 
  ggplot( aes(x=distance,y=Count, fill=distance))+
   geom_bar(stat="identity", width = 0.5)+
  geom_text(aes(label = prc),
    position = position_dodge(0.5), hjust=-0.5)+
  guides(fill=FALSE)+labs(x="",y=" ",title=paste0("Distance to " , admin2," boundary"))+
   ylim(0,ymax)+
   coord_flip()+
  theme+
  theme(axis.text.x=element_blank(),axis.ticks.x=element_blank(),
        axis.text.y=element_text(size=12),axis.ticks.y=element_blank(),
        panel.background = element_blank(),panel.border = element_blank())
 
  plots<-ggarrange(p1, p2,ncol = 2, nrow = 1, common.legend = FALSE, legend ="right")
plots
   
```    

***
